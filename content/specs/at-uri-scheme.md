---
title: AT URIスキーム（at://）
summary: ATPリポジトリデータをアドレス指定するためのURIスキーム。

---

# AT URIスキーム（at://）

AT URIスキーム（`at://`）は、特定のリポジトリ内の個々のレコードを参照するのを簡単にします。これはDIDまたはハンドルによって識別された特定のリポジトリで、AT URIsはリポジトリ内のコレクションやリポジトリ全体（別名、アイデンティティ）を参照するためにも使用できます。

以下のAT URIsは同じリポジトリ内の同じレコードを参照しています。一方はアカウントのDIDを使用し、もう一方はアカウントのハンドルを使用しています。

- `at://did:plc:44ybard66vv44zksje25o7dz/app.bsky.feed.post/3jwdwj2ctlk26`
- `at://bnewbold.bsky.team/app.bsky.feed.post/3jwdwj2ctlk26`

:::note
**ハンドルベースのAT URIの注意事項**

ハンドルを使用したAT URIsは耐久性がありません。

ユーザーがハンドルを変更すると、そのハンドルを使用しているAT URIsは無効になり、ハンドルが再利用される場合には別のリポジトリのレコードを指す可能性があります。

AT URIsはコンテンツアドレスではないため、それらが参照するレコードの_内容_も時間とともに変更される可能性があります。
:::

### 構造

AT URIの完全で一般的な構造は次のとおりです。

```text
"at://" AUTHORITY [ PATH ] [ "?" QUERY ] [ "#" FRAGMENT ]
```

URIの**authority**部分はハンドルまたはDIDのいずれかであり、リポジトリに関連するアイデンティティを示しています。ハンドルは時間とともに異なるDID（したがって異なるリポジトリ）を指すことができることに注意してください。強い参照に関するディスカッションと「使用法と実装」のセクションで説明されているように、DIDを指定するかどうかに関係なく、この部分は必須です。

現在のatproto Lexiconの使用では、**query**および**fragment**の部分はまだサポートされておらず、特定のパスの固定パターンのみが許可されています。

```text
"at://" AUTHORITY [ "/" COLLECTION [ "/" RKEY ] ]
```

**authority**セクションは必須で、正規化されなければならず、DIDの場合は「blessed」DIDメソッドの1つである必要があります。パスのオプションの**collection**セクションは正規化された[NSID](./nsid)である必要があります。パスのオプションの**rkey**セクションは有効な[Record Key](./record-key)である必要があります。

リポジトリ内の特定のレコードを指すAT URIは*強い*参照ではないことに注意してください。それはコンテンツアドレスではありません。レコードは時間の経過とともに変更されるか削除される可能性があります。またはDID自体が削除されたり利用できなくなったりする可能性があります。 `did:web`の場合、DID（したがってリポジトリ）の制御は時間とともに変更される可能性があります。Authorityセクションのハンドルを使用したAT URIの場合、ハンドルからDIDへのマッピングも変更される可能性があります。

AT URIsと`https://`、`ftp://`、`wss://`などの一般的なURLフォーマットとの主要な意味の違いは、AT URIの「authority」部分が示すリソースのネットワークの場所を示さないことです。ハンドルがAuthorityセクションにある場合でも、ホスト名はアイデンティティの検索にしか使用されず、通常はリポジトリコンテンツの最終的なホストではありません（別名、ハンドルのホスト名は通常PDSホストではありません）。

### 一般的なURIの適合性

AT URIsは、IETF [RFC-3986](https://www.rfc-editor.org/rfc/rfc3986)で定義されているUniversal Resource Identifiersの一般的な構文を満たします。これらはその文書で概説されている一部の一般的なURIの機能を利用していますが、すべてではありません。一般的なURI部分と機能の要約として：

- 二重スラッシュで先行するAuthority部分：サポートされています
- 空のAuthority部分：サポートされていません
- Userinfo：現在サポートされていませんが、将来の使用を予約しています。ハンドルの前に単独の`@`文字がある場合は無効です（例：`at://@handle.example.com`は無効です）
- ホストとポートの分離：サポートされていません。構文がAuthority部分のDIDと競合しています
- パス部分：サポートされており、オプションです
- クエリ：一般的な構文でサポートされていますが、現在は使用されていません
- フラグメント：一般的な構文でサポートされていますが、現在は使用されていません
- 相対参照：まだサポートされていません
- 正規化ルール：一般的な構文でサポートされていますが、現在は使用されていません

AT URIsはWHATWG URL Standard ([https://url.spec.whatwg.org/](https://url.spec.whatwg.org/))に準拠していません。URIのAuthority部分のDID内のコロン文字をエンコードせずに使用することは、この標準によって許可されていません。DIDと`host:port`ペアを区別することは可能です。DIDには常に少なくとも2つのコロンがあり、常に`did:`で始まり、DIDメソッドには数字を含めることができません。

### 完全なAT URI構文

AT URIsの完全な構文は、将来の使用ケースに対応する柔軟なもので、パス構造、クエリパラメータ、およびフラグメント部の将来の拡張を含みます。完全な構文規則は次のとおりです。

- 全体のURIはASCII文字のサブセットに制限されています
- 下記の参照のために、[RFC-3986](https://www.rfc-editor.org/rfc/rfc3986)で定義されている未予約文字のセットには、英数字（`A-Za-z0-9`）、ピリオド、ハイフン、アンダースコア、チルダ（`.-_~`）が含まれています
- 最大全体長は8キロバイトです（将来的に短縮される可能性があります）
- 文字の16進符号化が許可されていますが（実際のところ必要ではありません）、大文字と小文字は区別されます
- URIスキームは`at`であり、先行する二重スラッシュを伴うAuthority部分が常に必要です。したがって、URIは常に`at://`で始まります
- Authorityセクションは必須であり、空でなければなりません。Authorityはatprotoハンドルまたはatprotoで使用する制限を満たすDIDのいずれかである必要があります。Authority部分はDIDの場合はホスト:ポートのペアとして解釈できないため、コロン文字（`:`）が使用されています。DID内のコロンと未予約文字はエスケープしてはいけませんが、他の予約文字（`#`、`/`、`$`、`&`、`@`）はエスケープする必要があります。
    - 現在の「blessed」DIDメソッドのいずれも、DID識別子でこれらの文字を許可していません
- オプションのパスセクションがAuthorityに続く場合があります。パスには単一のスラッシュ（`/`）で区切られた複数のセグメントを含めることができます。一般的なURIパスの正規化ルールを使用できます。
- オプションのクエリパートが一般的なURI構文の後に続く場合があります
- オプションのフラグメントパートはJSON Path構文を使用して許可されています

### 制限付きAT URI構文

現在、Lexiconsで`at-uri`タイプに使用される有効なAT URIのサブセットがあります。クエリパラメータとフラグメントは現在使用されていません。Authorityの後にパスがない場合、トレーリングスラッシュは許可されません。URIは正規化形式である必要があり、個々のサブ識別子もすべて正規化されている必要があります。

```text
AT-URI        = "at://" AUTHORITY [ "/" COLLECTION [ "/" RKEY ] ]

AUTHORITY     = HANDLE | DID
COLLECTION    = NSID
RKEY          = RECORD-KEY
```

### 正規化

特にatprotoレコードに含まれる場合、表現が再現可能であり、簡単な文字列の等価性チェックで使用できるように、厳格な正規化に従うべきです。

- URIのいずれかの部分に不要な16進符号化は行わないでください
- 16進符号化された文字の場合、16進符号化された文字は大文字である必要があります
- URIスキームは小文字である必要があります
- ハンドルとしてのAuthority：小文字
- DIDとしてのAuthority：正規化形式であり、重複する16進符号化はありません。たとえば、DIDがすでに16進符号化されている場合は、パーセント記号を再度エンコードしないでください。
- パス部分にトレーリングスラッシュはありません
- パス部分に重複するスラッシュまたは「ドット」セクション（たとえば、`/./`または`/abc/../`）はありません
- パス内のNSID：ドメインAuthority部分は小文字です
- レコードキーは大文字と小文字を区別し、正規化されません
- レポジトリやレコードを参照する場合、クエリとフラグメントの部分は含まれていない必要があります

URIのパスを正規化し、`..` / `.`相対参照を削除するための一般的なルールについては、[RFC-3986](https://www.rfc-editor.org/rfc/rfc3986)を参照してください。

### 例

有効なAT URIs（一般的およびLexicon構文の両方）：

```text
at://foo.com/com.example.foo/123
```

有効な一般的なAT URI構文、現在のLexiconでは無効：

```text
at://foo.com/example/123     // 無効なNSID
at://computer                // 有効なDIDまたはハンドルではありません
at://example.com:3000        // 有効なDIDまたはハンドルではありません
```

無効なAT URI（両方のコンテキストで）

```text
at://foo.com/                // トレーリングスラッシュ
at://user:pass@foo.com       // 現在サポートされていないuserinfo
```


### 使用および実装のガイドライン

一般的なURIおよびURLの解析ライブラリは、AT URIsで使用することができることがありますが、常にではありません。重要な要件は、URIのAuthority（またはオリジン）部分をユーザー情報、ホスト、およびポートのサブパーツに解析せずに、単純な文字列として操作できることです。具体的には、Python 3の`urllib`モジュール（標準ライブラリから）、Javascriptの`url-parse`パッケージが動作します。Golangの`net/url`パッケージは動作しません。および一般的なRust URL解析クレートのほとんどは動作しません。

特に他のリポジトリからレコードを参照する場合、最善の方法はAuthorityセクションにDIDを使用し、ハンドルではなくDIDを使用することです。アプリケーションの表示用には、ハンドルを使用して人間が読み取り可能な代替手段として使用できます。HTMLでは、AT-URIのハンドルバージョンを*表示*し、DIDバージョンに*リンク*（`href`）することが許可されています。

他のレコードへの*強い*参照が必要な場合、AT URIにCIDハッシュを追加することが最良の方法です。

Lexicons（API、レコードなど）では、特定のAT URIのバリアントが、一般的な`at-uri`文字列形式を超えて要求される場合があります。たとえば、レコード内からのレコードへの参照は通常、AuthorityセクションにDIDが必要であり、URIにはコレクションとrkeyのパスセグメントを含める必要があります。これらの基準を満たさないURIは検証に失敗します。

JSON Pathフラグメント構文とLexiconリファレンス構文を混同しないでください。両方ともJSONドキュメント内の他のフィールドを参照するために`#`ベースのフラグメントを使用しますが、たとえばJSON Path構文はスラッシュ（`#/key`）で始まります。


### 可能性のある将来の変更

最大長制約が変更される可能性があります。

Lexiconsの`at-uri`フィールドで相対参照がサポートされるかもしれません。たとえば、同じリポジトリ内の他のレコードを参照する1つのレコードが`../<collection>/<rkey>`相対パス構文を使用できます。
