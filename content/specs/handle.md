---
title: ハンドル
summary: 人間にやさしいアカウント識別子の仕様。

---

# ハンドル

DID（分散識別子）は、atprotoのアカウントのための長期的な永続的な識別子ですが、人間には不透明で使いづらいことがあります。ハンドルはアカウントのためのより永続性の低い識別子です。アカウントハンドルとアカウントDIDのリンクを検証するメカニズムはDNSに依存し、ネットワークホストへの接続も考慮されます。そのため、すべてのハンドルは有効なネットワークホスト名である必要があります。ほとんどの有効な「ホスト名」は有効なハンドルでもありますが、いくつかの例外があります。

「ホスト名」（すべての「DNS名」のサブセット）の定義は、時間といくつかのRFCにわたり進化しています。関連する文書には、[RFC-1035](https://www.rfc-editor.org/rfc/rfc1035)、[RFC-3696](https://www.rfc-editor.org/rfc/rfc3696)セクション2、および[RFC-3986](https://www.rfc-editor.org/rfc/rfc3986)セクション3があります。

## ハンドル識別子の構文

レキシコン文字列フォーマットタイプ：`handle`

他の標準を合成し、特に「ハンドル」構文を定義するには：

- 全体のハンドルはASCII文字のみを含み、最大で253文字までです（実際にはハンドルはやや短い長さに制限される可能性があります）。
- 全体のハンドルはASCIIピリオド（`.`）で区切られた複数のセグメント（標準文書では「ラベル」と呼ばれます）に分割されます。
- 先頭または末尾のASCIIピリオドは許可されず、少なくとも2つのセグメントが必要です。つまり、「裸の」トップレベルドメインはハンドルとして許可されません。有効な「ホスト名」と「DNS名」であっても、DNS名の「トレイリングドット」構文はハンドルには許可されません。
- 各セグメントは、少なくとも1文字、最大で63文字まで（ピリオドを含まず）でなければなりません。許可される文字はASCIIのアルファベット（`a-z`）、数字（`0-9`）、ハイフン（`-`）です。
- セグメントはハイフンで始まりまたは終了してはなりません。
- 最後のセグメント（「トップレベルドメイン」）は数字で始まってはいけません。
- ハンドルは大文字小文字を区別せず、小文字に正規化する必要があります（すなわち、ASCII `A-Z` を `a-z` に正規化します）。

明示的に述べると（上記の規則はすでにこれを指定しています）、ハンドルにはハンドルのプレフィックス/サフィックスとして含まれるスペース、ヌルバイト、結合文字、その他のASCII制御文字は許可されません。

現代の「ホスト名」（したがってハンドル）はほとんどの位置でASCII数字を許可しますが、最後のセグメント（トップレベルドメイン、TLD）は数字で始まってはいけません。

IPアドレスは有効な構文ではありません。IPv4アドレスは最後のセグメントが数字で始まり、IPv6アドレスはコロン（`:`）で区切られています。

ハンドル構文の参照正規表現（regex）は以下の通りです：

```
/^([a-zA-Z0-9]([a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?\.)+[a-zA-Z]([a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?$/
```

## その他の非構文制限

「予約された」トップレベルドメインは構文の検証には失敗すべきではありません（例：atproto Lexicon検証）、ただし、登録、解決などの試みは直ちに失敗する必要があります。参照：[https://en.wikipedia.org/wiki/Top-level_domain#Reserved_domains](https://en.wikipedia.org/wiki/Top-level_domain#Reserved_domains)

ローカルネットワーク上のmDNSのための`.local`ホスト名はatprotoでは使用しないでください。

`.onion` TLDはTorプロトコルの隠れたサービスのための特別なケースです。Torを介したハンドルの解決にはエコシステム全体のサポートが必要なため、現在は禁止されています。

上記をまとめると、初期の非許可TLDのリストには以下が含まれます：

- `.alt`
- `.arpa`
- `.example`
- `.internal`
- `.invalid`
- `.local`
- `.localhost`
- `.onion`

`.test` TLDは例、テスト、開発のために用意されています。atprotoの開発では使用できますが、実際の環境では失敗するはずです。

`.invalid` TLDは特別な`handle.invalid`値のためにのみ使用されるべきです（以下参照）。この値は構文的にはLexiconスキーマ言語で有効ですが、ほとんどのコンテキストで有効なハンドルとして受け入れられるべきではありません。

## 識別子の例

構文的に有効なハンドル（既存のTLDがあるかどうかはわからない）：

```
jay.bsky.social
8.cn
name.t--t        // 実際のTLDではありませんが、構文はOK
XX.LCS.MIT.EDU
a.co
xn--notarealidn.com
xn--fiqa61au8b7zsevnm8ak20mc4a87e.xn--fiqs8s
xn--ls8h.test
example.t        // 実際のTLDではありませんが、構文はOK
```

構文エラー：

```
jo@hn.test
💩.test
john..test
xn--bcher-.tld
john.0
cn.8
www.masełkowski.pl.com
org
name.org.
```

構文は有効ですが、他の制限のために常に解決に失敗する必要がある：

```
2gzyxa5ihm7nsggfxnu52rck2vv4rvmdlkiu3zzui5du4xyclen53wid.onion
laptop.local
blah.arpa
```

## ハンドルの解決

ハンドルはatprotoで限定的な役割を果たし、ほぼすべての状況でDIDに解決する必要があります。解決メカニズムは特定の時点でドメイン名に対する合理的な権限を示し、効率的に検索できる必要があります。現在サポートされている解決メカニズムは、DIDを含むTXT DNSレコードを使用するものと、特別な`/.well-known/` URLを使用するものの2つです。

クライアントはハンドルを解決するためにネットワークサービス（たとえば、PDS）を利用でき、`com.atproto.identity.resolveHandle`エンドポイントを使用してハンドルを解決する必要はありません。通常は解決を直接実装する必要はありません。

DNS TXTメソッドは個々のハンドル構成のための推奨される解決メソッドですが、サービスは両方のメソッドを完全にサポートする必要があります。HTTPSメソッドの想定される使用ケースは、数千または数百万のDNS TXTレコードの登録を自動化するインフラを持っていない既存の大規模Webサービスです。

ハンドルは、DIDも解決され、現在のDIDドキュメントがハンドルに戻るように確認されるまで信頼されたり、有効と見なされてはいけません。ハンドルとDIDの間のリンクは双方向に確認されなければならず、そうでないと誰でもサードパーティアカウントのためにハンドルエイリアスを作成できてしまいます。

### DNS TXTメソッド

この解決方法では、`_atproto`サブドメインの下にハンドルホスト名のためにDNS TXTレコードが登録されます。レコードの値は、フルドメインに続いて`did=`プレフィックスを持つべきです。この方法は[RFC-1464](https://www.rfc-editor.org/rfc/rfc1464.html)、"Using the Domain Name System To Store Arbitrary String Attributes"に準拠しています。

例えば、ハンドル`bsky.app`は、名前が`_atproto.bsky.app`であるTXTレコードを持ち、値は`did=did:plc:z72i7hdynmk6r22z27h6tvur`のようになります。

`did=`で始まらない値を持つTXTレコードは無視されるべきです。任意の時点で単一の有効なレコードのみ存在すべきであり、異なるDIDを持つ複数の有効なレコードが存在する場合は、解決は失敗すべきです。この場合、解決は遅延後に再試行するか、または再帰的なリゾルバを使用することができます。

非常に長いハンドルは、追加の`_atproto.`名前セグメントがDNSクエリの最大253文字を超える場合、この方法を使用して解決できません。そのようなハンドルにはHTTPSメソッドが適しています。DNSSECは必要ありません。

### HTTPS well-knownメソッド

この解決方法では、ハンドルドメインのウェブサーバーが特別な`/.well-known/atproto-did`パスで特別なwell-knownエンドポイントを実装します。有効なHTTP応答はHTTP成功ステータス（2xx）を持ち、`Content-Type`ヘッダが`text/plain`に設定され、HTTPボディにはプレフィックスやラッパー形式なしでDIDが含まれている必要があります。

例えば、ハンドル`bsky.app`は`https://bsky.app/.well-known/atproto-did`へのGETリクエストで解決され、有効な応答は次のようになります：

```
HTTP/1.1 200 OK
Content-Length: 33
Content-Type: text/plain
Date: Wed, 14 Jun 2023 00:47:21 GMT

did:plc:z72i7hdynmk6r22z27h6tvur

```

応答の`Content-Type`ヘッダは厳密に検証する必要はありません。応答ボディをDIDとして解析する前に、プレフィックスとサフィックスの空白を取り除くことは許容されています。

実際のハンドル解決には、デフォルトポート（443）でのセキュアなHTTPSが必要です。HTTPは主にローカル開発とテストに使用すべきです。

HTTPリダイレクト（例：301、302）は許可されており、合理的な回数のリダイレクトホップまで許容されます。

### 無効なハンドル

既知のDIDのハンドルが解決できなくなった場合、それを無効としてマークするべきです。APIの応答では、特別なハンドル値`handle.invalid`を使用して、特定のDIDに対する双方向に有効なハンドルが存在しないことを示すことができます。このハンドルはほとんどの状況（検索クエリ、APIリクエストなど）で使用できません。

### 解決のベストプラクティス

両方の解決方法を並行して試み、最初に利用可能な成功した結果を使用することは許容されています。2つのメソッドが対立する結果（異なるDID）を返す場合、DNS TXT結果が優先されますが、結果を曖昧として記録し、後で再試行することも許容されています。

サービスがハンドル解決結果を一定期間まで内部的にキャッシュし、定期的に再解決するのはベストプラクティスと見なされます。DNS TTL値はキャッシュの寿命を提供できますが、ハンドル解決のユースケースにはおそらく過剰なくらい（寿命が短すぎる）です。

再帰的なDNSリゾルバの使用は、アカウントがハンドルを変更して確認を待っている使用ケースにとって重要な伝播遅延に役立ちます。

両方のテクニックで、比較的信頼できるネットワーク環境と構成から解決リクエストを開始することが有益です。解決リクエストを複数の地域と環境から実行することは、トラフィックの操作や意図的にセグメンテーションされた応答に関する懸念を緩和するのに役立ちます。

## 使用および実装ガイドライン

ユーザーインターフェースで`@jay.bsky.team`のように「at」記号でハンドルを前置することはできますが、これはレコード、API、および他のバックエンドコンテキストでは有効な構文ではありません。

国際化ドメイン名（"IDN"または "punycode"）は低レベルのハンドル構文には直接関係ありません。エンコードされた形式では、IDNは既に有効なホスト名であり、したがって有効なハンドルです。そのようなハンドルはエンコードされたASCII形式で保存および送信されなければなりません。IDNハンドルはUnicodeとして解析および表示される場合がありますが、これはオプションです。

ハンドルは大文字と小文字を区別しないため、ユーザーの入力を安全に正規化するために小文字（ASCII）形式に正規化できます。正規化（小文字）されたハンドルのみがレコードに保存され、アウトバウンドAPI呼び出しで使用されるべきです。アプリケーションはユーザー提供のケース情報を保存し、ハンドルを小文字以外で表示しようとしてはなりません。例えば、ハンドル入力文字列`BlueskyWeb.xyz`は、`blueskyweb.xyz`として正規化、保存、および表示されるべきです。非常に長い全小文字のハンドルは可読性とアクセシビリティの課題となり得ます。サブドメインの分離（ピリオド）、ハイフン、またはアプリケーションプロトコルでの「表示名」の使用が助けになります。

非常に長いハンドルはユーザーインターフェース上の課題を提供することが知られていますが、プロトコルでは許容されており、アプリケーション開発者はそれらをサポートすることが期待されています。

よく知られたドメインに似たハンドルはセキュリティおよびなりすましの課題を提供します。例えば、`paypa1.com`や`paypal.cc`のようなハンドルが`paypal.com`と混同される可能性があります。非常に長いハンドルは先頭または末尾で切り詰められると類似の問題が発生する可能性があります（`paypal.com…`）。

ハンドルは一般的にはローカルコンテキストに切り詰められるべきではありません。例えば、`@jay.bsky.social`のハンドルは、`bsky.social`サービスのローカルコンテキストでも`@jay`として表示されるべきではありません。

ハンドルの「名前空間」（例：登録ドメインのサブドメインとして）のプロバイダは、任意の追加のハンドル制限を課すことができます。許容されるセグメントの長さを理にかなったものに制約し、`www`、`admin`、`mail`などの一般的なセグメント文字列を予約することが推奨されています。 "一般に許可されていないユーザー名"の複数の公共リストが出発点として使用できます。

実用的な観点から、ハンドルは最大で244文字まで制限されるべきです。これは、DNS検証が`_atproto.`プレフィックスと連動して動作し、その総体的な名前が有効である必要があるためです。

ハンドルホスト名は主流のDNSドメイン名であることが期待されます。非標準のTLDや非標準の命名システムを使用するハンドルは、atprotoエコシステム内の他のネットワークサービスおよびプロトコル実装との相互運用性に失敗する可能性があります。

アカウントをホストするPDS実装は、アカウントのハンドルがもはや検証できない（`handle.invalid`状況）場合、レポジトリの変更を防ぐことができるかもしれません。他のネットワークサービスは通常、コンテンツの表示を継続すべきです（壊れを防ぐため）、可能であれば文脈に関するノートや警告インジケータを付けることがあります。

## 可能性のある将来の変更

ハンドルの構文は比較的安定しています。

将来的には`.onion`ハンドルがいずれかの時点で許可される可能性があります。