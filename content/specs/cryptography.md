---
title: 暗号学
summary: AT Protocolで使用される暗号システム、曲線、および鍵の種類
---

# 暗号学

プロトコル全体で現在サポートされているのは2つの楕円曲線であり、実装は両方を完全にサポートすることが期待されています。

- `p256`楕円曲線：別名"NIST P-256"、`secp256r1`（`r`に注意）、`prime256v1`とも呼ばれます
    - この曲線はWebCrypto APIに含まれています。個人デバイスハードウェア（Trusted Platform Modules（TPMs）およびモバイルセキュアエンクレーブ）やクラウドハードウェアセキュリティモジュール（HSMs）で一般的にサポートされています
- `k256`楕円曲線：別名"NIST K-256"、`secp256k1`（`k`に注意）
    - この曲線はWebCrypto APIには含まれていません。これはBitcoinおよび他の仮想通貨で使用され、その結果、個人の秘密鍵管理技術で広くサポートされています。クラウドHSMsでもサポートされています。

完全な曲線名を書いたときの微妙な視覚的な違いのため、通常、`p256`または`k256`として言及します。

Blueskyのatprotoリファレンス実装は、すべてのコンテキストで両方の曲線をサポートし、デフォルトで`k256`鍵ペアを作成します。

両システムの鍵ポイントには損失のない「圧縮」表現があり、これは公開鍵を共有する際に便利です。これは通常、`k256`に対してはネイティブでサポートされていますが、`p256`に対しては追加のメソッドや手順が必要な場合があります。これについては、[02, 03 or 04? So What Are Compressed and Uncompressed Public Keys?](https://medium.com/asecuritysite-when-bob-met-alice/02-03-or-04-so-what-are-compressed-and-uncompressed-public-keys-6abcb57efeb6)で詳細を読むことができます。

atprotoでデータに署名する際の一般的なパターンは、データをDAG-CBORでエンコードし、CBORバイトをSHA-256でハッシュし、生のバイト（16進数のエンコードではなく）を取得した後、そのハッシュバイトに署名することです。

## ECDSA署名の操作可能性

一部のECDSA署名は、新しい異なるが有効な署名を生成するように変換できます。これには秘密署名キーまたは署名されたデータへのアクセスは必要ありません。このプロパティを使用して可能な攻撃の範囲は限定されていますが、これは予期しないプロパティです。

特に`k256`に関しては、「low-S」署名と「high-S」署名の違いがあり、[Bitcoin BIP-0062](https://github.com/bitcoin/bips/blob/master/bip-0062.mediawiki)で議論されています。

atprotoでは、「low-S」署名バリアントの使用が`p256`および`k256`の両方で必要です。

atprotoでは、署名は常に暗号ライブラリが提供する検証ルーチンを使用して検証されるべきであり、署名値を生のバイトとして比較することは避けるべきです。

## 公開鍵エンコード

公開鍵を文字列としてエンコードする際、推奨される表現はマルチベース（特に`base58btc`を使用）およびマルチコードプレフィックスを使用して特定の鍵タイプを示すことです。エンコード自体に鍵のタイプに関するメタデータを埋め込むことで、それらは曖昧さなく解析できます。この形式で公開鍵をエンコードするプロセスは次のとおりです。

- 公開鍵の曲線「ポイント」をバイトとしてエンコードします。小さい「コンパクト」または「圧縮」表現を使用するようにしてください。これは通常、`k256`にとっては簡単ですが、`p256`キーに対しては特別な引数や構成が必要な場合があります
- 適切な曲線マルチコーデック値を、varintでエンコードされたバイトとして、鍵バイトの前に追加します：
    - `p256`（圧縮、33バイトの鍵長）：`p256-pub`、コード0x1200、varintでエンコードされたバイト：[0x80, 0x24]
    - `k256`（圧縮、33バイトの鍵長）：`secp256k1-pub`、コード0xE7、varintバイト：[0xE7, 0x01]
- 結合されたバイトを`base58btc`でエンコードし、`z`文字でプレフィックスを付けて、マルチベースエンコードされた文字列を生成します

逆のデコードプロセスは同じで、識別された曲線タイプをコンテキストとして使用します。

`did:key`識別子としてキーをエンコードするには、上記のマルチベースエンコーディングを使用し、ASCIIプレフィックス`did:key:`を追加します。この識別子は、DID PLCメソッドの内部実装の一部として使用されます。

[atproto DID仕様書](/specs/did)に記載されている、マルチコーデックタイプの値を含まないレガシーマルチベースエンコーディングのバリアントに注意してください。このフォーマットは非推奨です。

### エンコード例

P-256の公開鍵、マルチベース（マルチコーデックあり）、および`did:key`としてエンコードされた例：

```
zDnaembgSGUhZULN2Caob4HLJPaxBh92N7rtH21TErzqf8HQo
did:key:zDnaembgSGUhZULN2Caob4HLJPaxBh92N7rtH21TErzqf8HQo
```

K-256の公開鍵、マルチベース（マルチコーデックあり）、および`did:key`としてエンコードされた例：

```
zQ3shqwJEJyMBsBXCWyCBpUBMqxcon9oHB7mCvx4sSpMdLJwc
did:key:zQ3shqwJEJyMBsBXCWyCBpUBMqxcon9oHB7mCvx4sSpMdLJwc
```

## 使用および実装のガイドライン

atprotoエコシステム全体でのプライベートキーの特定の推奨バイトまたは文字列エンコーディングはありません。時折、単純な16進数エンコーディングが使用されることもありますし、時にはマルチベースとマルチコーデックタイプ情報の有無で使用されることもあります。

## 可能性のある将来の変更

サポートされる暗号システムのセットはゆっくりと進化すると予想されています。特定の時点で可能な限り少ないシステムを持つことには、相互運用性と実装上の利点があります。
